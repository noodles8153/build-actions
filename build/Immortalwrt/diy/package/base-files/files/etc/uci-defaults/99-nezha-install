#!/bin/sh
echo "ğŸš€ è®¾ç½®å¼€æœºåå»¶è¿Ÿå¯åŠ¨ Nezha å®‰è£…ä»»åŠ¡..."

# åˆ›å»ºå¼€æœºå»¶è¿Ÿå®‰è£…è„šæœ¬
cat << 'EOF' > /etc/init.d/nezha-agent-install
#!/bin/sh /etc/rc.common
START=99

start() {
    logger -t nezha "â³ ç­‰å¾…ç½‘ç»œå‡†å¤‡..."
    sleep 15  # ç­‰å¾…ç½‘ç»œåˆå§‹åŒ–å®Œæˆ

    logger -t nezha "ğŸ“¦ æ­£åœ¨ä¸‹è½½ Nezha Agent å®‰è£…è„šæœ¬..."
    if curl -sSL https://raw.githubusercontent.com/nezhahq/scripts/main/agent/install.sh -o /tmp/agent.sh; then
        chmod +x /tmp/agent.sh
        logger -t nezha "ğŸš€ å¼€å§‹å®‰è£… Nezha Agent..."

        # æ‰§è¡Œå®‰è£…ï¼Œæ›¿æ¢ä»¥ä¸‹ç¯å¢ƒå˜é‡ä¸ºä½ çš„å€¼
        env NZ_SERVER=nezha.15908153.xyz:443 \
            NZ_TLS=true \
            NZ_CLIENT_SECRET=NvVNqLSrMrKqyqgaCQzG7ey3OYsnWkZO \
            /tmp/agent.sh > /tmp/nezha-install.log 2>&1

        logger -t nezha "âœ… Nezha Agent å®‰è£…å®Œæˆï¼"

        # åˆ é™¤è‡ªèº«è„šæœ¬ï¼Œé˜²æ­¢é‡å¤æ‰§è¡Œ
        rm -f /etc/init.d/nezha-agent-install
    else
        logger -t nezha "âŒ ä¸‹è½½ Nezha å®‰è£…è„šæœ¬å¤±è´¥ï¼Œè·³è¿‡å®‰è£…ã€‚"
    fi
}
EOF

# è®¾ç½®æƒé™å¹¶å¼€æœºè‡ªåŠ¨å¯åŠ¨
chmod +x /etc/init.d/nezha-agent-install
/etc/init.d/nezha-agent-install enable

# åˆ é™¤è‡ªèº«ï¼Œç¡®ä¿åªæ‰§è¡Œä¸€æ¬¡
rm -f /etc/uci-defaults/99-nezha-install

#!/bin/sh
echo "🚀 设置开机后延迟启动 Nezha 安装任务..."

# 创建开机延迟安装脚本
cat << 'EOF' > /etc/init.d/nezha-agent-install
#!/bin/sh /etc/rc.common
START=99

start() {
    logger -t nezha "⏳ 等待网络准备..."
    sleep 15  # 等待网络初始化完成

    logger -t nezha "📦 正在下载 Nezha Agent 安装脚本..."
    if curl -sSL https://raw.githubusercontent.com/nezhahq/scripts/main/agent/install.sh -o /tmp/agent.sh; then
        chmod +x /tmp/agent.sh
        logger -t nezha "🚀 开始安装 Nezha Agent..."

        # 执行安装，替换以下环境变量为你的值
        env NZ_SERVER=nezha.15908153.xyz:443 \
            NZ_TLS=true \
            NZ_CLIENT_SECRET=NvVNqLSrMrKqyqgaCQzG7ey3OYsnWkZO \
            /tmp/agent.sh > /tmp/nezha-install.log 2>&1

        logger -t nezha "✅ Nezha Agent 安装完成！"

        # 删除自身脚本，防止重复执行
        rm -f /etc/init.d/nezha-agent-install
    else
        logger -t nezha "❌ 下载 Nezha 安装脚本失败，跳过安装。"
    fi
}
EOF

# 设置权限并开机自动启动
chmod +x /etc/init.d/nezha-agent-install
/etc/init.d/nezha-agent-install enable

# 删除自身，确保只执行一次
rm -f /etc/uci-defaults/99-nezha-install
